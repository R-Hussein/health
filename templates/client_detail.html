{% extends "base.html" %}

{% block title %}{{ client.name }} - Healthcare System{% endblock %}

{% block content %}
<h2>{{ client.name }} (CPR: {{ client.cpr }})</h2>
<p>Municipality: {{ client.municipality }}</p>

<div class="section">
    <h3>Basic Info</h3>
    <p>Address: {{ client.address }}</p>
    <p>Doctor: {{ client.doctor_name }}</p>
    <p>Clinic ID: {{ client.clinic_id }}</p>
</div>


<div class="section">
    <h3>Medical Data</h3>
    <h4>Medicines</h4>
    <ul>
        {% for med in medicines %}
        <li>{{ med.name }} - Side Effects: {{ med.side_effect }} [{{ 'Active' if med.active else 'Inactive' }}]</li>
        {% endfor %}
    </ul>
    
    <h4>Medication Times</h4>
    <ul>
        {% for mt in med_times %}
        <li>{{ mt.date }} at {{ mt.time }} - {{ 'Taken' if mt.taken else 'Pending' }}</li>
        {% endfor %}
    </ul>
</div>

<div class="section">
    <h3>Last Notifications</h3>
    <table class="notification-table">
        <tr>
            <th>Date/Time</th>
            <th>Urgency</th>
            <th>Message</th>
        </tr>
        {% for note in notifications %}
        <tr class="notification {{ note.urgency }}">
            <td>{{ note.date_time.strftime('%Y-%m-%d %H:%M') }}</td>
            <td>{{ note.urgency|replace('_', ' ') }}</td>
            <td>{{ note.note }}</td>
        </tr>
        {% endfor %}
    </table>
    {% if notification_count > 3 %}
    <a href="{{ url_for('notification_history', client_id=client.id) }}" class="btn btn-secondary">
        View Full Notification History ({{ notification_count }} total)
    </a>
    {% endif %}
</div>

<!--action-buttons -->
<div class="action-buttons">
    <a href="{{ url_for('add_visit', client_id=client.id) }}" class="btn btn-primary">
        Record New Visit
    </a>
    
    <a href="{{ url_for('manage_client_medicines', client_id=client.id) }}" class="btn btn-primary">
        Manage Medicines
    </a>

    <a href="{{ url_for('edit_client', client_id=client.id) }}" class="btn btn-secondary">
        Edit Client
    </a>
</div>

<!-- Camera viewer area 
<div id="cameraWrap" style="margin-top:1rem; display:none;">
  <div style="position:relative; width:100%; max-width:900px; aspect-ratio:16/9; background:#000; border-radius:8px; overflow:hidden;">
    <img id="cameraStream" alt="Live camera"
         style="width:100%; height:100%; object-fit:contain; display:block;">
    <div id="camStatus"
         style="position:absolute; top:8px; left:8px; padding:.25rem .5rem; border-radius:.4rem; font:14px system-ui; background:rgba(0,0,0,.5); color:#fff; display:none;">
      Connecting…
    </div>
  </div>
</div>
-->
<div class="camera-panel" id="cameraPanel" style="transition:height .25s ease;border-radius:12px;overflow:hidden;background:#111;">
  <div style="padding:8px; display:flex; gap:8px;">
    <button id="btnOpenCam" class="btn btn-primary"
            onclick="openCamera({{ client.id }}, '{{ client.cpr }}')">
      Open Camera
    </button>
    <button id="btnCloseCam" class="btn btn-secondary"
            onclick="closeCamera({{ client.id }}, '{{ client.cpr }}')" disabled>
      Close Camera
    </button>
  </div>

  <!-- Collapsed by default -->
  <div id="camWrap" style="height:0;">
    <img id="camFeed" alt="Live camera" style="max-width:100%; display:block; margin:auto;">
  </div>
</div>

<script>
async function openCamera(clientId, cpr) {
  try {
    const res = await fetch(`/client/${clientId}/camera/open`, {method: 'POST', headers: {'X-Requested-With':'fetch'}});
    const data = await res.json();
    if (!data.ok) { alert(data.message || 'Failed to open camera'); return; }

    // set stream src (push MJPEG served by server)
    const img = document.getElementById('camFeed');
    img.src = data.stream_url; // e.g. /client/<CPR>/mjpeg
    // expand the viewport
    const wrap = document.getElementById('camWrap');
    wrap.style.height = '360px'; // adjust to your preferred expanded height

    // toggle buttons
    document.getElementById('btnOpenCam').disabled = true;
    document.getElementById('btnCloseCam').disabled = false;
  } catch (e) {
    console.error(e);
    alert('Open camera error');
  }
}

async function closeCamera(clientId, cpr) {
  try {
    await fetch(`/client/${clientId}/camera/close`, {method: 'POST', headers: {'X-Requested-With':'fetch'}});
  } catch (_) {}

  // stop the stream (browser side) and collapse
  const img = document.getElementById('camFeed');
  img.removeAttribute('src');           // hard stop network
  img.src = '';                         // extra safety
  const wrap = document.getElementById('camWrap');
  wrap.style.height = '0';

  // toggle buttons
  document.getElementById('btnOpenCam').disabled = false;
  document.getElementById('btnCloseCam').disabled = true;
}
</script>



<!-- Lock Control (ESP32) -->
<section class="card" style="border:1px solid #ddd;border-radius:12px;padding:1rem;margin:1rem 0">
  <h3 style="margin:0 0 .5rem 0">Door Lock</h3>
  <div style="font-size:.95rem;color:#555;margin-bottom:.5rem">
    Device Name: <strong>{{ client.device_name or '— not set —' }}</strong>
  </div>
  <div style="display:flex;gap:.5rem;flex-wrap:wrap">
    <button id="btn-open"  class="btn btn-success" type="button">Open</button>
    <button id="btn-close" class="btn btn-danger"  type="button">Close</button>
    <span id="lock-msg" style="margin-left:.5rem;"></span>
  </div>
</section>

<script>
function getCookie(name) {
  const m = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
  return m ? decodeURIComponent(m[2]) : '';
}
(function(){
  const csrf = getCookie('csrf_token');
  const cid  = {{ client.id }};
  const msg  = document.getElementById('lock-msg');
  const hit = async (path) => {
    msg.textContent = '...';
    try {
      const r = await fetch(`/client/${cid}/lock/${path}`, {
        method: 'POST',
        headers: { 'X-CSRFToken': csrf }
      });
      const j = await r.json();
      msg.textContent = j.ok ? 'OK' : (j.message || 'Error');
    } catch (e) {
      msg.textContent = 'Network error';
    }
  };
  document.getElementById('btn-open').onclick  = () => hit('open');
  document.getElementById('btn-close').onclick = () => hit('close');
})();
</script>

<!-- Visits section-->
<div class="section">
    <h3>Recent Visits</h3>
    {% if visits %}
    <table class="visit-table">
        <tr>
            <th>Date</th>
            <th>Nurse</th>
            <th>Notes</th>
            <th>Next Visit</th>
        </tr>
        {% for visit in visits %}
        <tr>
            <td>{{ visit.date }} {{ visit.time }}</td>
            <td>{{ visit.nurse_name }}</td>
            <td>{{ visit.notes|truncate(50) }}</td>
            <td>{{ visit.next_visit_date or '-' }}</td>
        </tr>
        {% endfor %}
    </table>
    {% if visit_count > 3 %}
    <a href="{{ url_for('visit_history', client_id=client.id) }}" class="btn btn-secondary">
        View Full Visit History ({{ visit_count }} total)
    </a>
    {% endif %}
    {% else %}
    <p>No visits recorded yet</p>
    {% endif %}
</div>

<script>
(function() {
  const openBtn  = document.getElementById('btnOpenCam');
  const closeBtn = document.getElementById('btnCloseCam');
  const wrap     = document.getElementById('cameraWrap');
  let   img      = document.getElementById('cameraStream');
  const badge    = document.getElementById('camStatus');
  const clientId = {{ client.id }};
  const fallbackStream = "{{ camera_url|default('http://192.168.0.102:81/stream', true) }}";

  let camOpen = false;
  let camUrl  = null;

  function getCookie(name) {
    // read CSRF token if present
    const m = document.cookie.match(new RegExp('(^|; )' + name + '=([^;]*)'));
    return m ? decodeURIComponent(m[2]) : null;
  }

  async function postJSON(url) {
    const headers = { 'Content-Type': 'application/json' };
    const csrf = getCookie('csrf_token');
    if (csrf) headers['X-CSRFToken'] = csrf;
    const res = await fetch(url, { method: 'POST', headers, credentials: 'same-origin' });
    return res;
  }

  async function openCameraInline() {
    if (camOpen) return;
    openBtn.disabled = true;
    badge.style.display = 'inline-block';
    badge.textContent = 'Opening…';

    try {
      const res = await postJSON(`/client/${clientId}/camera/open`);
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const j = await res.json();
      if (!(j.ok || j.status === 'ok')) throw new Error(j.message || 'Open failed');

      camUrl = (j.stream_url || fallbackStream);
      const bust = camUrl + (camUrl.includes('?') ? '&' : '?') + 't=' + Date.now();

      wrap.style.display = 'block';
      img.src = bust;

      setTimeout(() => {
        badge.textContent = 'Live';
        openBtn.disabled = true;
        closeBtn.disabled = false;
        camOpen = true;
      }, 300);
    } catch (e) {
      console.error('[camera] open error:', e);
      alert('Network error opening camera');
      badge.style.display = 'none';
      openBtn.disabled = false;
    }
  }

  async function closeCameraInline() {
    closeBtn.disabled = true;
    badge.style.display = 'inline-block';
    badge.textContent = 'Closing…';

    try {
      const res = await postJSON(`/client/${clientId}/camera/close`);
      if (!res.ok) throw new Error(`HTTP ${res.status}`);

      // Tear down MJPEG: clear src + replace node so the HTTP stream closes
      img.src = '';
      const newImg = img.cloneNode(false);
      img.replaceWith(newImg);
      img = newImg;
      img.id = 'cameraStream';

      wrap.style.display = 'none';
      badge.style.display = 'none';
      camOpen = false;
      openBtn.disabled = false;
    } catch (e) {
      console.error('[camera] close error:', e);
      alert('Network error closing camera');
      closeBtn.disabled = false;
    }
  }

  // Wire buttons after DOM is ready (avoids scope issues)
  document.addEventListener('DOMContentLoaded', () => {
    openBtn.addEventListener('click', openCameraInline);
    closeBtn.addEventListener('click', closeCameraInline);
  });
})();
</script>

<style>
.btn-servo {
    background-color: #4a89dc;
    color: white;
    padding: 8px 16px;
    border-radius: 4px;
    border: none;
    cursor: pointer;
    transition: background-color 0.3s;
}
.btn-servo:hover {
    background-color: #3b7dd8;
}
.btn-servo i {
    margin-right: 8px;
}
.notification-table {
    width: 100%;
    border-collapse: collapse;
}
.notification-table th {
    background-color: #f2f2f2;
}
.notification-table td, .notification-table th {
    padding: 8px;
    border: 1px solid #ddd;
}
.notification.normal { background-color: #e8f5e9; }
.notification.urgent { background-color: #fff8e1; }
.notification.very_urgent { background-color: #ffe0b2; }
.notification.critical { background-color: #ffcdd2; }
</style>

{% endblock %}
